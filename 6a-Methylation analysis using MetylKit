############ Methylseq analysis on R using MethylKit (Akalin et al., 2012) #############
############ Has to be adapted to the current data #############

setwd("~/R")
.libPaths("/home1/datahome/tsoldour/R/x86_64-conda_cos6-linux-gnu-library/3.6")


#Loading packages
library(dplyr)
library(tidyverse)
library(ggplot2)
library(methylKit)
library(pheatmap)
library(genomation)
library(GenomicTools)
library(GenomicFeatures)
library(rtracklayer)
library(genomationData)

# 1- RETRIEVE METHYLATION CALL FILES
# Reading the methylation call files (at the methylkit format) and merge them into file.list

file.list <- list(system.file("data/gastrula", 
                              "E1A_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "E1E_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "E2A_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "E2C_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "E3A_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "E3D_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "T1C_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "T1D_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "T2A_CpG.methylKit", package = "methylKit"),
                  system.file("data/gastrula",
                              "T2B_CpG.methylKit", package = "methylKit"))

file.list

# Read the files into methylRawlist objet : myobj
myobj_G <- methRead(file.list,
                  sample.id=list("E1A","E1E", "E2A", "E2C", "E3A", "E3D",
                                 "T1C", "T1D", "T2A", "T2B"),
                  assembly="Roslin",
                  treatment=c(1,1,1,1,1,1,0,0,0,0), # Here we define experimental conditions
                  context="CpG")


# 2- DESCRIPTIVE STATISTICS ON SAMPLES
# Here methylation statistics for each sample
for (obj in myobj_G){
  getMethylationStats(obj,plot=TRUE,both.strands=FALSE)
  getCoverageStats(obj,plot=TRUE,both.strands=FALSE)
}

# 3- COMPARATIVE ANALYSIS
# Need to merge samples with bases covered in all samples
meth_G=methylKit::unite(myobj_G, destrand=FALSE)

# Cluster samples based on the similarity of their methylation profiles
clusterSamples(meth_G, dist="correlation", sd.threshold=0.8, method="ward", plot=TRUE)

# Summarize methylation information into till windows (500 bp here), allowing to analyse DMRs instead of DMCs only
tiles_G=tileMethylCounts(myobj_G,win.size=500,step.size=500)
head(tiles[[1]],3)

# Need to merge samples with bases covered in all samples
meth_till_G=methylKit::unite(tiles_G, destrand=FALSE)
as.data.frame(meth_till_G)

# Export merged data into a table
write.table(meth_till_G, file="Gastrula_meth_tile_unite.txt", sep="\t", quote=FALSE) # To perform differential analysis without methylkit

# Cluster the samples based on the similarity of their methylation profiles
clusterSamples(meth_till, dist="correlation", sd.threshold=0.8, method="ward", plot=TRUE)

# 3- DIFFERENTIALLY METHYLATED BASES
# Can also be done with the per tile data
# Calculate differential methylation by cytosines
myDiffG=calculateDiffMeth(meth_G, mc.cores = 2, adjust = "fdr")


#get hyper methylated BASES - select bases that have methylation difference larger than 25%
myDiff25p.hyper=getMethylDiff(myDiffG,difference=25,qvalue=0.05,type="hyper")
myDiff25p.hyper

# get hypo methylated BASES
myDiff25p.hypo=getMethylDiff(myDiffG,difference=25,qvalue=0.05,type="hypo")
myDiff25p.hypo

# get all differentially methylated BASES
myDiff25p=getMethylDiff(myDiffG,difference=25,qvalue=0.05)
myDiff25p

# Visualize the distribution of differentially methylated BASES
diffMethPerChr(myDiff,plot=TRUE,qvalue.cutoff=0.05, meth.cutoff=25)

MethylDiff = getMethylDiff(myDiffG, difference=25,
                           qvalue=0.05, type="all")

# -4 ANNOTATING DIFFERENTIALLY METHYLATED CpGs
# Reading the gene .bed file
gene.obj=readTranscriptFeatures(system.file("data", "GCA.bed",
                                            package = "methylKit"), remove.unusual = FALSE)
gene.obj

Exons=gene.obj$exons
Introns=gene.obj$introns
TSS=gene.obj$TSSes
promoteur=gene.obj$promoters

# Annotate differentially methylated CpGs with promoter/exon/intron using annotation data
diffAnn=annotateWithGeneParts(as(myDiff25p1,"GRanges"),gene.obj)
diffAnn
